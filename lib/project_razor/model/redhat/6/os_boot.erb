#!/bin/bash

# Wait for network to come up when using NetworkManager.
if service NetworkManager status >/dev/null 2>&1 && type -P nm-online; then
    nm-online -q --timeout=10 || nm-online -q -x --timeout=30
    [ "$?" -eq 0 ] || exit 1
fi

# Configure hostname.
hostname <%= hostname.split('.')[0] %>
sed -i '1i\127.0.0.1 <%= hostname %> <%= hostname.split('.')[0] %>\' /etc/hosts
[ "$?" -eq 0 ] && curl <%= callback_url("postinstall", "set_hostname_ok") %> || curl <%= callback_url("postinstall", "set_hostname_fail") %>

# BASE packages
yum -y groupinstall base
[ "$?" -eq 0 ] && curl <%= callback_url("postinstall", "base_packages_install_ok") %> || curl <%= callback_url("postinstall", "base_packages_install_fail") %>

# Get current IP

for i in `ls /sys/class/net/`
do
  if test "X$i" == "Xlo"; then
    continue
  fi
  if ! `ip addr li $i | grep -q inet`; then
    continue
  else
    IP=`ip addr li $i | sed -ne "s/.*inet \(.*\)\/.*/\1/p"`
    IP=`echo $IP`
  fi
done

# Send IP up
curl <%= callback_url("postinstall", "send_ips") %>/$IP
# get final script
curl <%= callback_url("postinstall", "boot") %> | sh
# Send final state
curl <%= callback_url("postinstall", "final") %> &
