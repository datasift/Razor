#!/usr/bin/env bash

# EPEL repo
rpm -ivh http://mirror.bytemark.co.uk/fedora/epel/6/i386/epel-release-6-8.noarch.rpm
sed -i "s/mirrorlist=https/mirrorlist=http/" /etc/yum.repos.d/epel.repo
[ "$?" -eq 0 ] && curl <%= callback_url("postinstall", "epel_repo_install_ok") %> || curl <%= callback_url("postinstall", "epel_repo_install_fail") %>

# If the date is not within 15 minutes (which can happen with VMs), chef will not run
yum install -y ntpdate
ntpdate time.dedipower.com
[ "$?" -eq 0 ] && curl <%= callback_url("postinstall", "ntp_install_ok") %> || curl <%= callback_url("postinstall", "ntp_install_fail") %>

#install chef package
wget -O /tmp/chef-12.17.44-1.el6.x86_64.rpm HEY_CHEF_PUT_URL_TO_CHEF_RPM_HERE
rpm -ivh /tmp/chef-12.17.44-1.el6.x86_64.rpm

## add chef.sysms.net to /etc/hosts
echo 46.236.16.252 chef.sysms.net >> /etc/hosts

## run chef
mkdir -p /etc/chef

(
cat <<'EOP'
<%= validation_key %>
EOP
) | awk NF > /etc/chef/validation.pem
chmod 0600 /etc/chef/validation.pem

(
cat <<'EOP'
<%= config_content %>
EOP
) > /etc/chef/client.rb

(
cat <<'EOP'
<%= first_boot.to_json %>
EOP
) > /etc/chef/first-boot.json

<%= start_chef %>
