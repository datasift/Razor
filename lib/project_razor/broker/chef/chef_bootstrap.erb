#!/usr/bin/env bash

# EPEL repo
rpm -ivh http://mirror.bytemark.co.uk/fedora/epel/6/i386/epel-release-6-8.noarch.rpm
[ "$?" -eq 0 ] && curl <%= callback_url("postinstall", "epel_repo_install_ok") %> || curl <%= callback_url("postinstall", "epel_repo_install_fail") %>

# If the date is not within 15 minutes (which can happen with VMs), chef will not run
yum install -y ntpdate
ntpdate time.dedipower.com
[ "$?" -eq 0 ] && curl <%= callback_url("postinstall", "ntp_install_ok") %> || curl <%= callback_url("postinstall", "ntp_install_fail") %>

#install chef package
wget -O /tmp/chef-11.8.0-1.el6.x86_64.rpm https://opscode-omnibus-packages.s3.amazonaws.com/el/6/x86_64/chef-11.8.0-1.el6.x86_64.rpm
rpm -ivh /tmp/chef-11.8.0-1.el6.x86_64.rpm

## run chef
mkdir -p /etc/chef

(
cat <<'EOP'
<%= validation_key %>
EOP
) | awk NF > /etc/chef/validation.pem
chmod 0600 /etc/chef/validation.pem

(
cat <<'EOP'
<%= config_content %>
EOP
) > /etc/chef/client.rb

(
cat <<'EOP'
<%= first_boot.to_json %>
EOP
) > /etc/chef/first-boot.json

<%= start_chef %>
