#!/usr/bin/env bash
# OS release and Arch
releasever=$(rpm -q --qf "%{VERSION}" $(rpm -q --whatprovides redhat-release))
basearch=$(uname -m)


# EPEL repo
if [ $releasever -eq 6 ]
then
  rpm -ivh http://mirror.bytemark.co.uk/fedora/epel/6/i386/epel-release-6-8.noarch.rpm
  sed -i "s/mirrorlist=https/mirrorlist=http/" /etc/yum.repos.d/epel.repo
elif [ $releasever -eq 7 ]
then
  rpm -ivh http://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
  sed -i "s/mirrorlist=https/mirrorlist=http/" /etc/yum.repos.d/epel.repo
else
  curl <%= callback_url("postinstall", "epel_repo_install_fail") %>
fi

[ "$?" -eq 0 ] && curl <%= callback_url("postinstall", "epel_repo_install_ok") %> || curl <%= callback_url("postinstall", "epel_repo_install_fail") %>

# If the date is not within 15 minutes (which can happen with VMs), chef will not run
yum install -y ntpdate
ntpdate time.dedipower.com
[ "$?" -eq 0 ] && curl <%= callback_url("postinstall", "ntp_install_ok") %> || curl <%= callback_url("postinstall", "ntp_install_fail") %>

#install chef package
wget -O /tmp/chef-12.17.44-1.el$releasever.$basearch.rpm https://yum:thisisnotarepository@repo.sysms.net/ds-baseline/el/$releasever/chef-12.17.44-1.el$releasever.$basearch.rpm
rpm -ivh /tmp/chef-12.17.44-1.el$releasever.$basearch.rpm

## add chef.sysms.net to /etc/hosts
echo 46.236.16.252 chef.sysms.net >> /etc/hosts

## run chef
mkdir -p /etc/chef

(
cat <<'EOP'
<%= validation_key %>
EOP
) | awk NF > /etc/chef/validation.pem
chmod 0600 /etc/chef/validation.pem

(
cat <<'EOP'
<%= config_content %>
EOP
) > /etc/chef/client.rb

(
cat <<'EOP'
<%= first_boot.to_json %>
EOP
) > /etc/chef/first-boot.json

<%= start_chef %>
